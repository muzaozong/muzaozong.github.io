<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Spring WebFlux简介 | 木枣粽子 | BLOG</title><meta name="description" content="Spring WebFlux简介"><meta name="keywords" content="Java,Spring WebFlux"><meta name="author" content="木枣粽子"><meta name="copyright" content="木枣粽子"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Spring WebFlux简介"><meta name="twitter:description" content="Spring WebFlux简介"><meta name="twitter:image" content="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture"><meta property="og:type" content="article"><meta property="og:title" content="Spring WebFlux简介"><meta property="og:url" content="https://www.cayun.me/spring/Spring%20Webflux%E7%AE%80%E4%BB%8B/"><meta property="og:site_name" content="木枣粽子 | BLOG"><meta property="og:description" content="Spring WebFlux简介"><meta property="og:image" content="https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.cayun.me/spring/Spring%20Webflux%E7%AE%80%E4%BB%8B/"><link rel="next" title="双十一压测&amp;Java应用性能问题排查总结" href="/https:/www.cayun.me/java/%E5%8F%8C%E5%8D%81%E4%B8%80%E5%8E%8B%E6%B5%8B&amp;Java%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%80%BB%E7%BB%93/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-93052608-1', 'auto');
ga('send', 'pageview');
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"KX6AGZG5MC","apiKey":"e06d1168d2b23e1e4ec2f5b0a65c9175","indexName":"blog","hits":{"per_page":8},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script><link rel="alternate" href="/atom.xml" title="木枣粽子 | BLOG" type="application/atom+xml">
</head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">木枣粽子 | BLOG</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> HOME</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">196</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">146</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">22</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> HOME</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#简介"><span class="toc_mobile_items-text">简介</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#webFlux与SpringMVC的简单比较"><span class="toc_mobile_items-text">webFlux与SpringMVC的简单比较</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定义"><span class="toc_mobile_items-text">定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#使用基础"><span class="toc_mobile_items-text">使用基础</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#几个概念"><span class="toc_mobile_items-text">几个概念</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#1-响应式编程"><span class="toc_mobile_items-text">1. 响应式编程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-响应式背压"><span class="toc_mobile_items-text">2. 响应式背压</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-响应式流-Reactive-Streams"><span class="toc_mobile_items-text">3. 响应式流(Reactive Streams)</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#API组成"><span class="toc_mobile_items-text">API组成</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-Reactor"><span class="toc_mobile_items-text">4. Reactor</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Reactor的简单使用"><span class="toc_mobile_items-text">Reactor的简单使用</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#WebFlux的简单使用"><span class="toc_mobile_items-text">WebFlux的简单使用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#web"><span class="toc_mobile_items-text">web</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#注解方式"><span class="toc_mobile_items-text">注解方式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#函数式端点方式"><span class="toc_mobile_items-text">函数式端点方式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#注解-VS-函数式端点"><span class="toc_mobile_items-text">注解 VS 函数式端点</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#webclient"><span class="toc_mobile_items-text">webclient</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#springMVC与spring-WebFlux的性能对比"><span class="toc_mobile_items-text">springMVC与spring WebFlux的性能对比</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#springMVC"><span class="toc_mobile_items-text">springMVC</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#spring-WebFlux"><span class="toc_mobile_items-text">spring WebFlux</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#结果分析"><span class="toc_mobile_items-text">结果分析</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#springMVC与spring-WebFlux的比较与选择"><span class="toc_mobile_items-text">springMVC与spring WebFlux的比较与选择</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#比较"><span class="toc_mobile_items-text">比较</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#选择"><span class="toc_mobile_items-text">选择</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#参考"><span class="toc_mobile_items-text">参考</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webFlux与SpringMVC的简单比较"><span class="toc-text">webFlux与SpringMVC的简单比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定义"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用基础"><span class="toc-text">使用基础</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#几个概念"><span class="toc-text">几个概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-响应式编程"><span class="toc-text">1. 响应式编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-响应式背压"><span class="toc-text">2. 响应式背压</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-响应式流-Reactive-Streams"><span class="toc-text">3. 响应式流(Reactive Streams)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API组成"><span class="toc-text">API组成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Reactor"><span class="toc-text">4. Reactor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Reactor的简单使用"><span class="toc-text">Reactor的简单使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebFlux的简单使用"><span class="toc-text">WebFlux的简单使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注解方式"><span class="toc-text">注解方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数式端点方式"><span class="toc-text">函数式端点方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-VS-函数式端点"><span class="toc-text">注解 VS 函数式端点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webclient"><span class="toc-text">webclient</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#springMVC与spring-WebFlux的性能对比"><span class="toc-text">springMVC与spring WebFlux的性能对比</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#springMVC"><span class="toc-text">springMVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-WebFlux"><span class="toc-text">spring WebFlux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结果分析"><span class="toc-text">结果分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#springMVC与spring-WebFlux的比较与选择"><span class="toc-text">springMVC与spring WebFlux的比较与选择</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#比较"><span class="toc-text">比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选择"><span class="toc-text">选择</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://uploadbeta.com/api/pictures/random/?key=BingEverydayWallpaperPicture)"><div id="post-info"><div id="post-title"><div class="posttitle">Spring WebFlux简介</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-12-10<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-12-20</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring/">spring</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字数总计: </span><span class="word-count">4.2k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>阅读时长: 15 分钟</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>近期对高并发的非阻塞式的web框架非常感兴趣，研究vert.x一直迟迟没有太多进展，恰巧发现spring家族里面也有一款相对应的框架Spring WebFlux，于是花了点时间看了一下，感觉还是比较容易上手的，于是此处做一个简单的关于Spring WebFlux的介绍。</p>
<p>首先，在开始之前，先提一下个人关于Java异步非阻塞框架的两个疑惑:</p>
<ol>
<li>异步非阻塞的web框架是如何支持数据库操作的，因为平时主流的数据库驱动都是同步阻塞的，例如jdbc？</li>
<li>如果Java的官方协程Loom出来之后，那我们前期有尝鲜使用的基础吗，即社区支持度怎么样？</li>
</ol>
<p><code>建议在看此文之前先了解一下NIO或着协程</code></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>简单地说，Spring WebFlux就是一个web服务器，为了可以更容易地理解，我们可以把它想象成另一种运行方式的SpringMVC。他们实现的功能几乎是一致的，就是实现了一个web服务器。但是他们的运行方式、实现原理、编码方式却是完全不同的。</p>
<h2 id="webFlux与SpringMVC的简单比较"><a href="#webFlux与SpringMVC的简单比较" class="headerlink" title="webFlux与SpringMVC的简单比较"></a>webFlux与SpringMVC的简单比较</h2><p>先来说说SpringMVC吧，SpringMVC的架构是基于Servlet的，并且使用同步阻塞IO的方式来运行的，大概如下图所示，每个请求均对应一个线程进行处理，也就是说有多少请求，就会产生多少线程（可以配置上限）。</p>
<p><img alt="image-20191210215141129" data-src="https://img.cayun.me/2019-12-10-135141.png" class="lazyload"></p>
<p>而WebFlux则采用的非阻塞IO的方式来进行处理，一般情况下，处理线程数量和core的核数保持一致，与请求数量无关，且IO不会产生线程阻塞。</p>
<p><img alt="image-20191210220420437" data-src="https://img.cayun.me/2019-12-10-140421.png" class="lazyload"></p>
<p>我们再从官网看一下两者之间的比较，</p>
<p><img alt="image-20191210224805635" data-src="https://img.cayun.me/2019-12-10-144806.png" class="lazyload"></p>
<p>从官网的对比信息，我们可以看到两者有两点核心不同:</p>
<ol>
<li>两者的运行容器不同，WebFlux是运行在netty或者servlet3.1+的容器中的，而springMVC则是运行在servlet容器中的。</li>
<li>两者底层交互的数据库是不同的，WebFlux只支持那些支持响应式调用的数据库，而springMVC则支持同步阻塞方式调用的数据库。</li>
</ol>
<p>本段说点题外话。众所周知，在Java中，很核心且很常用的jdbc是同步阻塞的，我曾经一直有这样一个疑问: <strong>现有的Java的NIO web框架是如何在数据库这一层做到异步非阻塞的呢？</strong>为了这个问题，我也尝试着做了一些简单的调查，发现了vert.x这个框架，这个框架通过自己实现一个新的jdbc客户端来支持了jdbc的异步非阻塞。而后我发现了WebFlux这个框架，可以从上图中发现，WebFlux的解法更加简单粗暴，WebFlux干脆直接不支持jdbc，不过想想也不失为一种解法，很多时候，老项目我们也不会考虑换成WebFlux，而新项目的选择权则相对会比较多，我们很多时候没必要特别拘泥于使用jdbc协议的数据库（至少个人项目可以这样）。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>从官方文档中，我对Spring WebFlux的定义做了一个简单的总结（仅代表个人观点，如有错误请指出）: </p>
<blockquote>
<p> Spring WebFlux是基于响应式流(Reactive Streams)API并运行在非阻塞服务器上的一个完全无阻塞、支持响应式背压的响应式web框架。</p>
</blockquote>
<h2 id="使用基础"><a href="#使用基础" class="headerlink" title="使用基础"></a>使用基础</h2><ol>
<li>首先Spring WebFlux是spring5.0之后才出现的，也就是说如果我们想使用WebFlux，我们得先使用spring5</li>
<li>由于WebFlux是基于NIO方式的，所以必须运行在非阻塞服务器上，目前官方支持netty、undertow以及Servlet3.1+的容器，默认情况下使用netty</li>
<li>WebFlux的响应式库默认使用的是Reactor，当然也可以自行选择RxJava</li>
<li>WebFlux同时支持Java和Kotlin</li>
</ol>
<h1 id="几个概念"><a href="#几个概念" class="headerlink" title="几个概念"></a>几个概念</h1><p>看到Spring WebFlux的定义，说实话，我是有点懵逼的，又是响应式流API，又是响应式背压，…，总而言之，都是一坨玄而又玄的概念。那么我们就从这个玄乎的概念入手。</p>
<h2 id="1-响应式编程"><a href="#1-响应式编程" class="headerlink" title="1. 响应式编程"></a>1. 响应式编程</h2><p>在上面的定义中，我们看到了一个全新的概念，叫做响应式编程，那么何为响应式编程呢？<strong>响应式编程是一种面向数据流和变化传播的编程范式</strong>。</p>
<p>响应式编程有如下几点特点:</p>
<ol>
<li>变化传递。假设定义了 a = b + 1 ，那么b的任何变化都会引起a的变化。例如响应式前端框架，当宽度变化时，页面布局就会相应变化。</li>
<li>基于数据流。在响应式编程中分为生产者和订阅者，生产者负责生产数据/事件，订阅者负责处理数据/事件，这些数据/事件在响应式编程中会通过数据流的形式发出。</li>
<li>声明式。我们事先声明好对数据流的处理流程，那么当数据流过来时，就会按照声明好的处理流程逐个处理。</li>
</ol>
<p>这种编程范围到底可以给我们带来怎样的好处呢？</p>
<p>想象一个性能监控系统，在前端部分，我们不再主动地去服务端拉取数据，而是由服务端源源不断地将数据推送过来，从而可以实时显示性能监控数据(变化图)，而我们唯一需要做的只是搭建一条能够传递变化的管道而已。</p>
<h2 id="2-响应式背压"><a href="#2-响应式背压" class="headerlink" title="2. 响应式背压"></a>2. 响应式背压</h2><blockquote>
<p>背压(Backpressure) 并不是响应式编程所独有的；其次，背压并不是一种「机制」，也不是一种「策略」。背压其实是一种现象：<strong>在数据流从上游生产者向下游消费者传输的过程中，上游生产速度大于下游消费速度，导致下游的 Buffer 溢出，这种现象就叫做 背压 出现。</strong></p>
<p>总结：背压 指的是在 Buffer 有上限的系统中，Buffer 溢出的现象；它的应对措施只有一个：丢弃新事件。</p>
<p>作者：扔物线<br>链接：<a href="https://www.zhihu.com/question/49618581/answer/237078934" target="_blank" rel="noopener">https://www.zhihu.com/question/49618581/answer/237078934</a></p>
</blockquote>
<h2 id="3-响应式流-Reactive-Streams"><a href="#3-响应式流-Reactive-Streams" class="headerlink" title="3. 响应式流(Reactive Streams)"></a>3. 响应式流(Reactive Streams)</h2><p>我们接下来再看一看另一个概念叫做响应式流(Reactive Streams)，那么何为响应式流呢？看一下官方的定义:</p>
<blockquote>
<p>响应式流是一个倡议，用来为具有非阻塞背压的异步流处理提供一个标准。</p>
</blockquote>
<p><small>具体的规范可以详见<a href="http://www.reactive-streams.org/" target="_blank" rel="noopener">Reactive Streams</a>和<a href="https://github.com/reactive-streams/reactive-streams-jvm" target="_blank" rel="noopener">reactive-streams-jvm</a></small></p>
<p>实现响应式流的库必须满足如下条件:</p>
<ul>
<li>具有处理无限数量的元素的能力</li>
<li>按序执行</li>
<li>组件之间异步传递元素</li>
<li>必须实现非阻塞背压</li>
</ul>
<p>响应式流提供了一个API规范以及测试套件。API规范如下，</p>
<h3 id="API组成"><a href="#API组成" class="headerlink" title="API组成"></a>API组成</h3><p>响应式流API由以下几个部分组成，第三方库必须要实现这几个接口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 生产者</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Publisher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 订阅者</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 订阅</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscription</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 处理者</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Processor</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt;, <span class="title">Publisher</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>一个典型的生产者与订阅者的交互场景如下:</p>
<p><img alt="image-20191212185757200" data-src="https://img.cayun.me/2019-12-12-105757.png" class="lazyload"></p>
<p>在Java9中，java.util.concurrent.Flow这个类定义了响应式流API，并且提供了SubmissionPublisher 和 ConsumerSubscriber 这两个默认实现。除此以外，还有一些实现了响应式流规范的Java库，例如RxJava和Reactor。</p>
<h2 id="4-Reactor"><a href="#4-Reactor" class="headerlink" title="4. Reactor"></a>4. Reactor</h2><p>Reactor是一个响应式编程库，与Spring是兄弟项目，WebFlux框架就是使用Reactor作为其内置的响应式支持。</p>
<p>在Reactor中的Publisher是由Flux和Mono两个类定义的，Flux用来操作0..N个元素的数据序列，而Mono用来操作0..1个元素的数据序列。映射关系举例如下: String对应Mono&lt;String&gt;，List&lt;String&gt;对应Flux&lt;String&gt; 。</p>
<h3 id="Reactor的简单使用"><a href="#Reactor的简单使用" class="headerlink" title="Reactor的简单使用"></a>Reactor的简单使用</h3><p>Flux和Mono提供了多种创建数据流的方法，其中just是一种比较直接的声明数据流的方式，其参数就是数据序列，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Mono.just(<span class="number">1</span>);</span></pre></td></tr></table></figure>

<p>但是光是有数据流还不够，我们还需要有订阅者，我们接下来将上面的所有数据全部都打印出来，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>).subscribe(System.out::println);</span></pre></td></tr></table></figure>

<p>甚至我们可以按照响应式流API的方式来实现一个控制流量速度的订阅者，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>).subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> Subscription subscription = <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.subscription = subscription;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    System.out.println(simpleDateFormat.format(<span class="keyword">new</span> Date()) + <span class="string">": "</span> + integer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      Thread.sleep(<span class="number">1000</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      e.printStackTrace();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    System.out.println(<span class="string">"Complete!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>执行结果如下，每秒输出一个数字，</p>
<p><img alt="image-20191212180256565" data-src="https://img.cayun.me/2019-12-12-100257.png" class="lazyload"></p>
<h1 id="WebFlux的简单使用"><a href="#WebFlux的简单使用" class="headerlink" title="WebFlux的简单使用"></a>WebFlux的简单使用</h1><p>上面讲了一坨虚的，那么下面来点实在的，我们来看一下WebFlux如何使用？</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>web部分，WebFlux的编程模型分为两种: 一种是通过带注解的Controller的方式，另一种是通过函数式端点的方式。接下来这两种方式我都来简单介绍一下吧。</p>
<h3 id="注解方式"><a href="#注解方式" class="headerlink" title="注解方式"></a>注解方式</h3><p>对于过去使用过springMVC的同学而言，这种方式并不陌生，spring全家桶的使用过程中注解随处可见，方便简单易用。那么对于WebFlux也是一样，WebFlux也同样支持注解的方式，而且WebFlux与springMVC的注解几乎是一模一样的。两者最主要的区别在于底层协议不同，WebFlux是基于响应式的<code>ServerHttpRequest</code>和<code>ServerHttpResponse</code>，而SpringMVC是基于<code>HttpServletRequest</code>和<code>HttpServletResponse</code>。</p>
<p>官方的样例如下,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> PersonRepository repository;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PersonController</span><span class="params">(PersonRepository repository)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">this</span>.repository = repository;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/person"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	<span class="function">Mono&lt;Void&gt; <span class="title">create</span><span class="params">(@RequestBody Publisher&lt;Person&gt; personStream)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.repository.save(personStream).then();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/person"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	<span class="function">Flux&lt;Person&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.repository.findAll();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/person/&#123;id&#125;"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	<span class="function">Mono&lt;Person&gt; <span class="title">findById</span><span class="params">(@PathVariable String id)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.repository.findOne(id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>我们可以自己写一个简单的例子来比较一下同步阻塞的方式与异步非阻塞的方式的区别,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UserController<span class="class">.<span class="keyword">class</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sync/hello"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">syncHello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        logger.info(<span class="string">"syncHello start"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        Thread.sleep(<span class="number">3000</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        String result = <span class="string">"world"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        logger.info(<span class="string">"syncHello end"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/async/hello"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        logger.info(<span class="string">"asyncHello start"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        Mono&lt;String&gt; result = Mono.delay(Duration.ofSeconds(<span class="number">3</span>)).thenReturn(<span class="string">"world"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        logger.info(<span class="string">"asyncHello end"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><img alt="image-20191211233030647" data-src="https://img.cayun.me/2019-12-11-153030.png" class="lazyload"></p>
<p><img alt="image-20191211232623385" data-src="https://img.cayun.me/2019-12-11-152624.png" class="lazyload"></p>
<p>从执行结果中我们可以两者在请求结果上是一致的，都是等待了3秒得到了结果。但是从日志中，我们可以发现两者的运行方式是完全不同的，其中同步阻塞的同步等待了3秒，而异步阻塞的方式则直接return了。</p>
<h3 id="函数式端点方式"><a href="#函数式端点方式" class="headerlink" title="函数式端点方式"></a>函数式端点方式</h3><p>这种方式在很多web框架中也极为常见，例如vert.x。下面写了一个简单的例子来说明函数式端点的方式的编码方式（基于spring-boot-starter-webflux2.2.2版本）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndPointApplication</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        UserHandler userHandler = <span class="keyword">new</span> UserHandler();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        RouterFunction&lt;ServerResponse&gt; router = route()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                .GET(<span class="string">"/user/hello"</span>, accept(APPLICATION_JSON), request -&gt; userHandler.hello())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                .GET(<span class="string">"/user/goodbye"</span>, accept(APPLICATION_JSON), request -&gt; userHandler.goodbye())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                .GET(<span class="string">"/user/always"</span>, accept(APPLICATION_JSON), request -&gt; userHandler.always())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                .build();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        HttpHandler httpHandler = RouterFunctions.toHttpHandler(router);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        ReactorHttpHandlerAdapter adapter = <span class="keyword">new</span> ReactorHttpHandlerAdapter(httpHandler);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        HttpServer.create().host(<span class="string">"0.0.0.0"</span>).port(<span class="number">9090</span>).handle(adapter).bind().block();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            lock.wait();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserHandler</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ServerResponse.ok().contentType(APPLICATION_JSON).bodyValue(<span class="string">"world"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">goodbye</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ServerResponse.ok().contentType(APPLICATION_JSON).bodyValue(<span class="string">"Bye bye."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">always</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ServerResponse.ok().contentType(TEXT_EVENT_STREAM)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">                .body(Flux.interval(Duration.ofSeconds(<span class="number">1</span>)).map(l -&gt; <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date())), String<span class="class">.<span class="keyword">class</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><img alt="image-20191212011159469" data-src="https://img.cayun.me/2019-12-11-171200.png" class="lazyload"></p>
<h3 id="注解-VS-函数式端点"><a href="#注解-VS-函数式端点" class="headerlink" title="注解 VS 函数式端点"></a>注解 VS 函数式端点</h3><p>相对而言，注解的方式似乎更容易编码，也更具备易读性。但是事实上函数式端点的方式也并不是一无是处，函数式端点的方式更加地轻量级。另一个比较重要的优点就是，函数式端点的方式中，应用程序负责从头到尾的请求处理，开发者对应用程序的掌控力会更强。</p>
<h2 id="webclient"><a href="#webclient" class="headerlink" title="webclient"></a>webclient</h2><p>此处不做详解，简单贴一个示例，具体的可以自行翻阅官方文档，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebClientApplication</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        WebClient client = WebClient.create(<span class="string">"http://www.baidu.com"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        Mono&lt;String&gt; result = client.get().uri(<span class="string">"/"</span>).retrieve().bodyToMono(String<span class="class">.<span class="keyword">class</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        System.out.println(result.block());   <span class="comment">// 为了方便起见，我这边直接使用block来获取数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h1 id="springMVC与spring-WebFlux的性能对比"><a href="#springMVC与spring-WebFlux的性能对比" class="headerlink" title="springMVC与spring WebFlux的性能对比"></a>springMVC与spring WebFlux的性能对比</h1><p>之前有在网上看到不少博主进行两者的性能对比时，往往在测试springMVC的时候会将并发数设置的大于tomcat的处理线程数，从而得出webFlux在高并发下远优于springMVC的结论，私以为这样的测试结果是不公平的，且很大程度上不合理的。(此处不去讨论其不合理性，接下来仅按照个人的想法来进行测试对比)</p>
<p>考虑到我们平时业务代码多以IO密集型的场景为主，且IO密集型的应用也更能得出我们想要的测试结果，因此此处我们的对比场景就是IO密集型场景。</p>
<p>分别贴上两边的代码，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// springMVC</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  	<span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  	<span class="meta">@Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  	<span class="meta">@RequestMapping</span>(<span class="string">"/redisTest"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">redisTest</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">int</span> x = count.getAndIncrement() % <span class="number">5</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        String result = redisTemplate.opsForValue().get(String.valueOf(x));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="string">"redis:"</span> + result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="string">"empty:"</span> + (x * x * x / <span class="number">3</span> * x / <span class="number">3</span> * (x + <span class="number">3</span>) / <span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// spring WebFlux</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  	<span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> ReactiveStringRedisTemplate redisTemplate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">  	<span class="meta">@RequestMapping</span>(<span class="string">"/redisTest"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">redisTest</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">int</span> x = count.getAndIncrement() % <span class="number">5</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().get(String.valueOf(x))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">                .map(s -&gt; <span class="string">"redis:"</span> + s)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                .switchIfEmpty(Mono.just(<span class="string">"empty:"</span> + (x * x * x / <span class="number">3</span> * x / <span class="number">3</span> * (x + <span class="number">3</span>) / <span class="number">3</span>)));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>Redis中的数据如下:</p>
<p><img alt="image-20191220010118214" data-src="https://img.cayun.me/2019-12-19-170118.png" class="lazyload"></p>
<p>压测命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">wrk -t4 -c1000 -d120s http://localhost:8080/redisTest</span></pre></td></tr></table></figure>

<p>springMVC应用的tomcat的最大线程数设置为1000。</p>
<h2 id="springMVC"><a href="#springMVC" class="headerlink" title="springMVC"></a>springMVC</h2><p><img alt="image-20191220010943616" data-src="https://img.cayun.me/2019-12-19-170944.png" class="lazyload"></p>
<p><img alt="image-20191220010932232" data-src="https://img.cayun.me/2019-12-19-170932.png" class="lazyload"></p>
<h2 id="spring-WebFlux"><a href="#spring-WebFlux" class="headerlink" title="spring WebFlux"></a>spring WebFlux</h2><p><img alt="image-20191220011327255" data-src="https://img.cayun.me/2019-12-19-171327.png" class="lazyload"></p>
<p><img alt="image-20191220011313639" data-src="https://img.cayun.me/2019-12-19-171314.png" class="lazyload"></p>
<h2 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h2><p>这次的压测其实比较简单，无法真实反映webFlux在真实生产/复杂业务上的表现，仅可以作为一定参考来使用。有一些与预期一致的地方，也有一些与预期不一致的地方，此处简单提一下。</p>
<p>与预期一致的地方:</p>
<ol>
<li>webFlux的吞吐率比springMVC要高</li>
<li>webFlux的延迟波动(标准差)比springMVC小</li>
</ol>
<p>与预期不一致的地方:</p>
<ol>
<li>webFlux的内存消耗貌似比springMVC要高（预期中webFlux的内存消耗要小一些）</li>
<li>webFlux的平均延迟比springMVC小很多（预期中两者延迟应该差不多）</li>
</ol>
<h1 id="springMVC与spring-WebFlux的比较与选择"><a href="#springMVC与spring-WebFlux的比较与选择" class="headerlink" title="springMVC与spring WebFlux的比较与选择"></a>springMVC与spring WebFlux的比较与选择</h1><h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><p>不管三七二十一，先贴一张官方的对比图。</p>
<p><img alt="spring mvc and webflux venn" data-src="https://img.cayun.me/2019-12-11-173739.png" class="lazyload"></p>
<p>接下来说一下简单的个人对比吧，</p>
<table>
<thead>
<tr>
<th></th>
<th>springMVC</th>
<th>WebFlux</th>
</tr>
</thead>
<tbody><tr>
<td>编码</td>
<td>容易</td>
<td>困难</td>
</tr>
<tr>
<td>第三方Java库</td>
<td>丰富</td>
<td>有限</td>
</tr>
<tr>
<td>支持的数据库</td>
<td>丰富</td>
<td>有限</td>
</tr>
<tr>
<td>普及率</td>
<td>广</td>
<td>小</td>
</tr>
<tr>
<td>性能</td>
<td>差</td>
<td>优</td>
</tr>
</tbody></table>
<p>其实可以直截了当地说WebFlux的最大的好处就是在性能方面了，其他的地方相对而言都是比较薄弱的。其次就是新技术总是更能勾引人的兴趣吧（当然这个并不能算是优点）。</p>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><p>接下来，同样的对官方的建议做一些总结和摘要吧，</p>
<ul>
<li>如果你的springMVC的应用跑得好好的，那没必要换成WebFlux。因为命令式编程更加容易编写、阅读以及调试，而且目前绝大多数Java库仍然是阻塞式的。</li>
<li>如果你依赖于一些阻塞式API（例如JPA、JDBC），那么springMVC往往是最好的选择。</li>
<li>可以在springMVC的应用中使用WebFlux的webclient模块。</li>
<li>如果有一个比较大的团队，却想要转响应式编程，则建议先从小处着手，例如先开始使用webclient。而且对于绝大多数情况，这种转换是没有必要的。</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>[1] <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux" target="_blank" rel="noopener">Spring WebFlux文档</a></p>
<p>[2] <a href="https://www.cnblogs.com/yuanrw/p/10050509.html" target="_blank" rel="noopener">响应式编程系列（一）：什么是响应式编程？reactor入门</a></p>
<p>[3] <a href="https://www.zhihu.com/question/49618581" target="_blank" rel="noopener">如何形象的描述反应式编程中的背压(Backpressure)机制？</a></p>
<p>[4] <a href="https://blog.51cto.com/liukang/2090922" target="_blank" rel="noopener">照虎画猫深入理解响应式流规范——响应式Spring的道法术器</a></p>
<p>[5] <a href="https://www.reactive-streams.org/" target="_blank" rel="noopener">Reactive Streams</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">木枣粽子</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="/https:/www.cayun.me/spring/Spring%20Webflux%E7%AE%80%E4%BB%8B/">https://www.cayun.me/spring/Spring%20Webflux%E7%AE%80%E4%BB%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.cayun.me">木枣粽子 | BLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java    </a><a class="post-meta__tags" href="/tags/Spring-WebFlux/">Spring WebFlux    </a></div><div class="post_share"></div></div></div></div><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2019 By 木枣粽子</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/muzaozong/hexo-theme-mzz-butterfly" target="_blank" rel="noopener"><span>mzz-butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="/js/search/algolia.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/baidupush.js"> </script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>